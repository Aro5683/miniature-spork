<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EduWarrior Premium</title>
<link rel="manifest" href="manifest.json">

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<style>
body{
margin:0;
font-family:'Segoe UI',sans-serif;
background:radial-gradient(circle at top,#0f172a,#020617);
color:#fff;
text-align:center;
}
.container{max-width:900px;margin:auto;padding:40px;}
h1 span{color:#f59e0b;}
.card{
background:rgba(255,255,255,.05);
padding:25px;
border-radius:20px;
margin-top:30px;
}
select, input{
width:100%;
padding:10px;
margin-top:10px;
border-radius:8px;
border:none;
background:#111827;
color:#fff;
}
button{
padding:12px;
border:none;
border-radius:10px;
background:linear-gradient(90deg,#f59e0b,#fbbf24);
font-weight:bold;
cursor:pointer;
width:100%;
margin-top:10px;
}
#viewer img{
width:100%;
margin-bottom:20px;
}
.success{color:#22c55e;}
.error{color:#ef4444;}
.notice{color:#38bdf8;margin-top:10px;}
</style>
</head>
<body>

<div class="container">

<h1>Premium B.Ed <span>Study Library</span></h1>

<!-- DOWNLOAD SECTION -->
<div class="card">
<h3>Download Book</h3>

<select id="bookSelect">
<option value="">Select Book</option>
<option value="notes.bedx">B.Ed Notes</option>
<option value="circulars.bedx">Circulars</option>
<option value="modelpapers.bedx">Model Question Papers</option>
</select>

<input type="text" id="name" placeholder="Full Name">
<input type="text" id="phone" placeholder="Phone">

<button onclick="downloadBook()">Download</button>

<p id="codeDisplay"></p>
<p id="offlineMessage" class="notice"></p>
</div>

<!-- OPEN SECTION -->
<div class="card">
<h3>Open Downloaded Book</h3>
<input type="file" id="fileInput" accept=".bedx,application/octet-stream,*/*">
<button onclick="openBook()">Open Book</button>
<p id="status"></p>
<div id="viewer"></div>
</div>

</div>

<script>
if("serviceWorker" in navigator){
navigator.serviceWorker.register("service-worker.js");
}

pdfjsLib.GlobalWorkerOptions.workerSrc=
"https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

const MASTER_SECRET="BED_SECRET_2025_PRIVATE";

function generateCode(){
let c="";for(let i=0;i<16;i++){c+=Math.floor(Math.random()*10);}return c;
}

function getDeviceID(){
return btoa(
navigator.userAgent+
screen.width+
screen.height+
navigator.platform
);
}

async function downloadBook(){

const book=document.getElementById("bookSelect").value;
const name=document.getElementById("name").value;
const phone=document.getElementById("phone").value;

if(!book||!name||!phone){
alert("Fill all details");
return;
}

const code=generateCode();

document.getElementById("codeDisplay").innerHTML=
"Your Code: <b>"+code+"</b><br>Send this after payment.";

document.getElementById("offlineMessage").innerText=
"After approval, you can turn off internet and use offline.";

const master=await fetch("masters/"+book).then(r=>r.text());
const m=JSON.parse(master);

const fileData={
iv:m.iv,
data:m.data,
code,
deviceID:getDeviceID(),
name,
phone,
book
};

const blob=new Blob(
[JSON.stringify(fileData)],
{type:"application/octet-stream"}
);

const a=document.createElement("a");
a.href=URL.createObjectURL(blob);
a.download="BEd_"+book+"_"+code+".bedx";
a.click();
}

async function openBook(){

const status=document.getElementById("status");
status.innerText="";

const file=document.getElementById("fileInput").files[0];
if(!file){status.innerText="Select file";return;}

const json=JSON.parse(await file.text());

if(json.deviceID!==getDeviceID()){
status.className="error";
status.innerText="This file is not for this device.";
return;
}

let approved=false;

if(localStorage.getItem("approved_"+json.code)){
approved=true;
}else{
const codes=await fetch(
"https://raw.githubusercontent.com/Aro5683/miniature-spork/main/codes.json?nocache="+Date.now()
).then(r=>r.json());

const found=codes.find(c=>c.code===json.code);

if(found&&found.approved){
approved=true;
localStorage.setItem("approved_"+json.code,true);
}
}

if(!approved){
status.className="error";
status.innerText="Payment not approved yet.";
return;
}

status.className="success";
status.innerText="Hii "+json.name+", your "+json.book+" is verified and opened successfully.";

const key=await crypto.subtle.importKey(
"raw",
await crypto.subtle.digest("SHA-256",
new TextEncoder().encode(MASTER_SECRET)),
{name:"AES-GCM"},false,["decrypt"]);

const decrypted=await crypto.subtle.decrypt(
{name:"AES-GCM",iv:new Uint8Array(json.iv)},
key,
new Uint8Array(json.data));

renderPDF(new Uint8Array(decrypted));
}

async function renderPDF(data){

const viewer=document.getElementById("viewer");
viewer.innerHTML="";

const pdf=await pdfjsLib.getDocument({data}).promise;

for(let i=1;i<=pdf.numPages;i++){
const page=await pdf.getPage(i);
const viewport=page.getViewport({scale:1.5});
const canvas=document.createElement("canvas");
canvas.width=viewport.width;
canvas.height=viewport.height;
await page.render({canvasContext:canvas.getContext("2d"),viewport}).promise;

const img=document.createElement("img");
img.src=canvas.toDataURL();
viewer.appendChild(img);
}
}
</script>

</body>
</html>
