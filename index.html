<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EduWarrior Premium</title>
<link rel="manifest" href="manifest.json">

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<style>
body{
margin:0;
font-family:'Segoe UI',sans-serif;
background:radial-gradient(circle at top,#0f172a,#020617);
color:#fff;
text-align:center;
}
.container{max-width:900px;margin:auto;padding:40px;}
h1 span{color:#f59e0b;}
.card{
background:rgba(255,255,255,.05);
padding:25px;
border-radius:20px;
margin-top:30px;
}
button{
padding:12px;
border:none;
border-radius:10px;
background:linear-gradient(90deg,#f59e0b,#fbbf24);
font-weight:bold;
cursor:pointer;
width:100%;
margin-top:10px;
}
input{
width:100%;
padding:10px;
margin-top:10px;
border-radius:8px;
border:none;
background:#111827;
color:#fff;
}
#viewer img{
width:100%;
margin-bottom:20px;
}
</style>
</head>
<body>

<div class="container">

<h1>Premium B.Ed <span>Study Materials</span></h1>

<div class="card">
<h3>Download Book</h3>
<input type="text" id="name" placeholder="Full Name">
<input type="text" id="phone" placeholder="Phone">
<button onclick="downloadFile()">Download</button>
<p id="codeDisplay"></p>
</div>

<div class="card">
<h3>Open Purchased File</h3>
<input type="file" id="fileInput">
<button onclick="openFile()">Open Book</button>
<p id="status"></p>
<div id="viewer"></div>
</div>

</div>

<script>
if("serviceWorker" in navigator){
navigator.serviceWorker.register("service-worker.js");
}

pdfjsLib.GlobalWorkerOptions.workerSrc=
"https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

const MASTER_SECRET="BED_SECRET_2025_PRIVATE";

function generateCode(){
let c="";for(let i=0;i<16;i++){c+=Math.floor(Math.random()*10);}return c;
}

function getDeviceID(){
return btoa(navigator.userAgent+screen.width);
}

async function downloadFile(){
const name=document.getElementById("name").value;
const phone=document.getElementById("phone").value;
if(!name||!phone){alert("Enter details");return;}

const code=generateCode();
document.getElementById("codeDisplay").innerHTML=
"Your Code: <b>"+code+"</b><br>Send this after payment.";

const master=await fetch("master.bedx").then(r=>r.text());
const m=JSON.parse(master);

const fileData={
iv:m.iv,
data:m.data,
code,
deviceID:getDeviceID(),
name,
phone
};

const blob=new Blob([JSON.stringify(fileData)]);
const a=document.createElement("a");
a.href=URL.createObjectURL(blob);
a.download="BEd_"+code+".bedx";
a.click();
}

async function openFile(){

const status=document.getElementById("status");
status.innerText="";

const file=document.getElementById("fileInput").files[0];
if(!file){status.innerText="Select file";return;}

const json=JSON.parse(await file.text());

if(json.deviceID!==getDeviceID()){
status.innerText="Not this device";
return;
}

let approved=false;

if(localStorage.getItem("approved_"+json.code)){
approved=true;
}else{
const codes=await fetch(
"https://raw.githubusercontent.com/Aro5683/miniature-spork/main/codes.json?nocache="+Date.now()
).then(r=>r.json());

const found=codes.find(c=>c.code===json.code);

if(found&&found.approved){
approved=true;
localStorage.setItem("approved_"+json.code,true);
}
}

if(!approved){
status.innerText="Payment not approved";
return;
}

const key=await crypto.subtle.importKey(
"raw",
await crypto.subtle.digest("SHA-256",
new TextEncoder().encode(MASTER_SECRET)),
{name:"AES-GCM"},false,["decrypt"]);

const decrypted=await crypto.subtle.decrypt(
{name:"AES-GCM",iv:new Uint8Array(json.iv)},
key,
new Uint8Array(json.data));

renderPDF(new Uint8Array(decrypted),json);
}

async function renderPDF(data,json){

const viewer=document.getElementById("viewer");
viewer.innerHTML="";

const pdf=await pdfjsLib.getDocument({data}).promise;

for(let i=1;i<=pdf.numPages;i++){
const page=await pdf.getPage(i);
const viewport=page.getViewport({scale:1.5});
const canvas=document.createElement("canvas");
canvas.width=viewport.width;
canvas.height=viewport.height;
await page.render({canvasContext:canvas.getContext("2d"),viewport}).promise;

const img=document.createElement("img");
img.src=canvas.toDataURL();
viewer.appendChild(img);
}

}
</script>

</body>
</html>
